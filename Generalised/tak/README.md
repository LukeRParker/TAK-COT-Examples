# TAK Server Only Kubernetes Deployment

## What is it?

Provides a repeatable and automated generation of containers for the TAK Server and Database, whilst also providing the yaml files needed to deploy the containers to Kubernetes.

#
## Dependencies

To get started, you will need to have the following:

**Building the Container Images**
- Windows OS to build the container images using the provided **container-creation.bat** file.
- Docker Desktop.
- Python (tested with version 3.9.7 and 3.11.4). Dev Container provided.
- TAK Server Docker .zip (you will need to register for an account at [tak.gov](https://tak.gov/) to get access to this as a download. Tested with TAK Server version 4.9 Release 23.0).

**Deploying to Kubernetes**

  **1. If using kubernetes-deployment.bat**:
  - Windows OS if using the provided .bat files.
  - Kubernetes running locally.
  - kubectl installed.

  **2. Else:**
  - Access to the target Kubernetes cluster.
  - kubectl installed.
  - *Note:* provided .yaml files in ./deployment assume locally held container images. These will require updating if you push your containers to a remote CR.

#
## Getting started

### 1. Creating the container images

Follow these steps to create your TAK Server and Database images.

1. Place the downloaded TAK Server .zip file (e.g takserver-docker-4.9-RELEASE-23.zip) in the folder that contains the **container-creation.bat** file.

2. Open Command Prompt.

3. In the Command Prompt, use the Change Directory "**cd**" command to navigate to the **StormCloud-TAK-Server-v2** folder.

4. Run the command below in Command Prompt.

   ```
   container-creation.bat
   ```

5. You will be asked to provide a password for the database and for the Certificate Authority. **NOTE:** These should be changed when the containers are deployed to their target environment, with any corresponding Kubernetes secrets also being updated to reflect the changes.

6. Your container images should now be available in Docker. You can now push these images to a remote CR. You will also see that additional yaml files have been created to support deployment to Kubernetes. **Note** - the secrets you provided earlier are written into the following files by **core_config_creator.py**. These files should be removed when no longer required.

```
./deployment/ca-password-secret.yaml
./deployment/db-password-secret.yaml
CoreConfig.xml
```

### 2. Deploying to Kubernetes

Follow these steps to get TAK Server and Database running in Kubernetes.

1. Modify **pg_hba.conf** to ensure the specified IP range corresponds to your Kubernetes cluster.

2. Open a Command Prompt with access to your Kubernetes cluster.

3. In the Command Prompt, use the Change Directory "**cd**" command to navigate to the **StormCloud-TAK-Server-v2** folder.

4. Run the command below in Command Prompt.

   ```
   kubernetes-deployment.bat
   ```

5. TAK Server should now be up and running within your Kubernetes cluster. Using the TLS certificates that were generated by **container-creation.bat**, you should be able to connect a client to Port 8089, or access WebTAK via the fully qualified domain name of the TAK Server and Port 8443.

#
## Certificates

**container-creation.bat** will automatically create certificates in the **./shared** folder, with **kubernetes-deployment.bat** creating a Kubernetes Secret for the Admin Certificate called **takserver-cert-p12** in the **default** namespace.  However, you will need to manually distribute your User Certificates and connect your clients.

Certificates are automatically generated on deployment of the TAK Server.  This is defined within the **Dockerfile-takserver** file.

```
ENV USER_COUNT=1
ENV ADMINS_COUNT=1
```

The Certificate Authority is also defined within the same Dockerfile.

```
ENV CITY=London
ENV ORGANIZATION=Microsoft
ENV ORGANIZATIONAL_UNIT=CSE
ENV STATE=London
```

In the original dsitribution for TAK Server, the file **cert-metadata.sh** hardcodes the password 'atakatak' for the Certificate Authority.  To improve security and avoid users having to modify deployment scripts, **cert-metadata.sh** has been changed to use an environment variable called **CA_PASSWORD_FILE** which holds the path to the file containing the Certificate Authority password. 

```
CAPASSWORD=$(cat $CA_PASSWORD_FILE)

CAPASS=${CAPASS:-$CAPASSWORD}
PASS=${PASS:-$CAPASS}
```

When **container-creation.bat** is run, the user is asked to provide a Certificate Authority password **core_config_creator.py** uses this to create a Kubernetes Secret yaml (ca-password-secret.yaml) with a base 64 encoded version of the password.  

**takserver-core-deployment.yaml** then mounts this secret as a volume with the path provided to the environment variable **CA_PASSWORD_FILE**.

To ensure that the certificates aren't invalidated when the TAK Server Pod restarts (i.e. persisting the config), the following modification has been made to the **configureInDocker.sh** script.

```
if [ ! -d /opt/tak/certs/files ] || [ -z "$(ls -A /opt/tak/certs/files)" ];
  then
    echo "Running the Army Software Factory Configurator"
    /opt/configurator/configurator.sh
fi
```

As we mount /opt/tak/certs/files as a persistent volume, the original script would skip certificate creation and configuration of the CA as the logic was to create the path if it didn't exist.  To account for this, the logic has been changed to reflect an OR condition where **configurator.sh** script will run if the path /opt/tak/certs/files does not exist, or contains no files.  This allows the initial creation of the CA and certificates to take place, and to then persist this information in the case of a Pod restart.

#
## Database


TAK Server uses a Postgresql database.  This is configured during deployment via **Dockerfile-takserver-db**.  The default username is **martiuser** and the default password is **atakatak**.  The configuration for the database is held within the **CoreConfig.xml** file which is created by **core_config_creator.py**. An extract of CoreConfig.xml is shown below.

```
    <security>
        <tls context="TLSv1.2" 
            keymanager="SunX509"
            keystore="JKS" keystoreFile="/opt/tak/certs/files/takserver.jks" keystorePass="atakatak" 
            truststore="JKS" truststoreFile="/opt/tak/certs/files/truststore-root.jks" truststorePass="atakatak">
         <!-- <crl _name="TAKServer CA" crlFile="certs/files/ca.crl"/>  -->
            
        </tls>
```

```
    <repository enable="true" numDbConnections="16" primaryKeyBatchSize="500" insertionBatchSize="500">
        <connection url="jdbc:postgresql://tak-database:5432/cot" username="martiuser" password="atakatak" />
    </repository>
```

As well as asking the user to provide a CA password, **container-creation.bat** also asks the user to provide a password for the PostrgeSQL database. This overcomes issues around keeping hard coded passwords in a repo.

#
## Handy tips

1. To access TAK Server through a Web Browser, you will need to use the hostname in the URL rather than 'localhost'.  Using 'localhost' will prevent WebTAK from connecting to TAK Server.  Assuming TAK Server is accessible via tls on port 8443, this would work:

   ```
   https://tablet-abco6kgj:8443/webtak/index.html
   ```
   And this won't:

   ```
   https://localhost:8443/webtak/index.html
   ```

2. The following sources have helped develop understanding and the current implementation of Cursor on Target (CoT) XML messages.

- https://github.com/deptofdefense/AndroidTacticalAssaultKit-CIV/tree/master/takcot/examples
- https://github.com/pinztrek/takpak/blob/master/takpak/mkcot.py

#
## How it all works

### TAK Server

One of the first things that **container-creation.bat** will do is unzip the TAK Server file you downloaded from [tak.gov](https://tak.gov/), and rename the folder to **tak-server**.  This enables you to use the same deployment mechanism for any version of TAK Server with minimal user interaction.  If **tak-server** already exists as a folder, it will be deleted automatically.

After unzipping the TAK Server file, **core_config_creator.py** will be run.  This will trigger the creation of the custom files needed to support the K8s deployment and copy them into the tak-server folder, namely:

- cert-metadata.sh (get CA password from environment variable)
- pg_hba.conf (specify IP range, which should correspond to your K8s cluster)

The following Dockerfiles are used to build the images for TAK Server and the PostgreSQL database.  These have been modified from the versions distributed by tak.gov to use images and packages that are being more actively maintained - in particular the use of the Microsoft maintained version of OpenJDK:

```
Dockerfile-takserver
Dockerfile-takserver-db
```

The following files are also used to support the stand-up of the TAK Server and database:

```
configurator.sh
configureInDocker.sh
cert-metadata.sh
CoreConfig.xml
pg_hba.conf
```

Once the Docker Images have been built by **container-creation.bat**, the yaml files held within **./deployment** can be deployed to Kubernetes using **kubernetes-deployment.bat** and the steps detailed previously.